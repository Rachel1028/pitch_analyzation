import os
import glob
import json
import pandas as pd
import matplotlib.pyplot as plt

DOWNLOAD_FOLDER = os.path.join(os.path.expanduser('~'), 'Downloads')

# 찾고 싶은 파일 패턴
FILE_PATTERN = 'melody_*.json'

def get_latest_file(folder, pattern):
    "지정된 폴더에서 패턴에 맞는 가장 최신 파일을 찾습니다."
    # 폴더 내의 모든 매칭 파일 경로 찾기
    search_path = os.path.join(folder, pattern)
    files = glob.glob(search_path)
    
    if not files:
        return None
    
    # 생성 시간 기준으로 정렬해서 가장 최신 파일 리턴
    latest_file = max(files, key=os.path.getctime)
    return latest_file

def visualize_json(file_path):
    print(f" 읽어오는 파일: {file_path}")
    
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
            
        if not data:
            print("데이터가 비어있습니다.")
            return

        df = pd.DataFrame(data)
        
        # 시간축 계산 (0초부터 시작)
        start_time = df['timestamp'].iloc[0]
        df['time_sec'] = (df['timestamp'] - start_time) / 1000
        
        # 그래프
        plt.figure(figsize=(12, 6))
        plt.plot(df['time_sec'], 
                 df['frequency'], 
                 label='Frequency (Hz)', 
                 color='royalblue', 
                 linewidth=2)
        plt.scatter(df['time_sec'], 
                    df['frequency'], color='red', s=10, zorder=5)
        for i in range(0, len(df), 5):
            plt.text(df['time_sec'][i], df['frequency'][i] + 5, 
                     df['note'][i], fontsize=9, color='darkred', ha='center')
        
        plt.title(f'Pitch Analysis: {os.path.basename(file_path)}', fontsize=16)
        plt.xlabel('Time (seconds)', fontsize=12)
        plt.ylabel('Frequency (Hz)', fontsize=12)
        plt.grid(True, linestyle='--', alpha=0.6)
        plt.legend()
        plt.show()
        
    except Exception as e:
        print(f" 오류 발생: {e}")

#실행 
if __name__ == "__main__":
    
    latest_file = get_latest_file(DOWNLOAD_FOLDER, FILE_PATTERN)
    
    if latest_file:
        visualize_json(latest_file)
    else:
        print("파일을 찾을 수 없습니다. 먼저 저장을 해주세요")