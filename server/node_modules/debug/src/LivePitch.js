let audioContext;
let pitch;
let stream;
let isListening = false; 
let melodyData = [];     // 데이터가 저장될 배열

// 모델 경로
const MODEL_URL = 'https://cdn.jsdelivr.net/gh/ml5js/ml5-data-and-models/models/pitch-detection/crepe/';


// 프로그램 초기화 (시작 버튼 클릭 시)
async function initProgram() {
  const startBtn = document.getElementById('startBtn');
  const statusMsg = document.getElementById('status');

  startBtn.style.display = 'none'; // 시작 버튼 숨김
  statusMsg.innerText = "모델 로딩 중... (잠시만 기다려주세요)";

  // 오디오 컨텍스트 생성
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  
  try {
    // 마이크 권한 요청
    stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    
    // 모델 로드 시작
    pitch = ml5.pitchDetection(MODEL_URL, audioContext, stream, modelLoaded);
    
  } catch (err) {
    console.error(err);
    alert("마이크 사용 권한이 필요합니다.");
    statusMsg.innerText = "오류: 마이크 권한 없음";
    startBtn.style.display = 'inline-block'; // 다시 보이게
  }
}

// 모델 로딩 완료 후 실행되는 함수
function modelLoaded() {
  console.log('Model Loaded!');
  resumeListening(); // 바로 측정 시작
}

// 2. 피치 감지 루프 (재귀 함수)
function getPitch() {
  // 멈춤 상태면 루프 종료
  if (!isListening) return;

  pitch.getPitch(function(err, frequency) {
    if (frequency) {
      // 주파수 -> 음계 변환
      const midiNum = freqToMidi(frequency);
      const note = midiToNote(midiNum);
      
      // 화면 업데이트
      document.getElementById('result').innerText = note;
      
      // 데이터 저장 (시간, 음계, 주파수)
      melodyData.push({
        timestamp: Date.now(),
        note: note,
        frequency: frequency
      });
    } else {
      document.getElementById('result').innerText = "--";
    }
    
    // 다시 getPitch 호출 (계속 반복)
    getPitch();
  });
}



//중단 버튼
function stopListening() {
  isListening = false; // 듣기 멈춤
  
  // 중단 버튼 숨기고 -> 다시 시작/저장 버튼 표시
  document.getElementById('stopBtn').style.display = 'none';
  document.getElementById('resumeBtn').style.display = 'inline-block';
  document.getElementById('saveBtn').style.display = 'inline-block';
  
  document.getElementById('status').innerText = "일시 중지됨 (저장하거나 다시 시작하세요)";
}

// 다시 시작 버튼
function resumeListening() {
  // 오디오 컨텍스트가 멈춰있다면 다시 켬
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
  
  isListening = true; // 듣기 활성화
  
  // 다시 시작/저장 버튼 숨기고 -> 중단 버튼 표시
  document.getElementById('resumeBtn').style.display = 'none';
  document.getElementById('saveBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display = 'inline-block';
  
  document.getElementById('status').innerText = "실시간 측정 중...";
  
  // 루프 다시 시작
  getPitch();
}

// 저장버튼
function confirmAndSave() {
  // 팝업 띄우기
  const userConfirmed = confirm(`현재까지 ${melodyData.length}개의 데이터가 모였습니다.\nJSON 파일로 저장하시겠습니까?`);
  
  if (userConfirmed) {
    saveFile();
  }
}

// 파일 다운로드 로직
function saveFile() {
  const jsonString = JSON.stringify(melodyData, null, 2);
  const blob = new Blob([jsonString], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `melody_data_${Date.now()}.json`; // 파일명: melody_data_시간.json
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}


//음계 저장
function freqToMidi(f) {
  return Math.round(69 + 12 * Math.log2(f / 440));
}

function midiToNote(midi) {
  const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  return notes[midi % 12] + (Math.floor(midi / 12) - 1);
}